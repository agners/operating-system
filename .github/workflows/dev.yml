# Home Assistant Operating System build workflow

name: Development build

on:
  workflow_dispatch:
  pull_request:
    types: [opened,synchronize,labeled]

jobs:
  version:
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'run-dev-build') }}
    name: Generate version
    runs-on: [ "ubuntu-20.04" ]
    outputs:
      version_main: ${{ steps.version_main.outputs.version_main }}
      version_dev: ${{ steps.version_dev.outputs.version_dev }}${{ steps.version_pr.outputs.version_pr }}
    steps:
      - name: debug
        run: |
          echo "${{ toJson(github.event.pull_request) }}"
          echo "${{ toJson(github.event.pull_request.labels.*.names) }}"
      - name: Generate Development build version for full dev build
        shell: bash
        id: version_dev
        run: |
          version_dev="dev$(date --utc +'%Y%m%d')"
          echo "Development version \"${version_dev}\""
          echo "::set-output name=version_dev::${version_dev}"
      - name: Generate Development build version for PR
        if: ${{ github.event.pull_request }}
        shell: bash
        id: version_pr
        run: |
          version_pr="+${{ github.event.pull_request.number }}"
          echo "PR \"${version_pr}\""
          echo "Issue comment ${{ github.event.issue_comment.comment }}"
          echo "::set-output name=version_pr::${version_pr}"
      - uses: actions/checkout@v2
      - name: Get Major/Minor version
        id: version_main
        run: |
          major=$(cat ${GITHUB_WORKSPACE}/buildroot-external/meta | grep VERSION_MAJOR | cut -d'=' -f2)
          build=$(cat ${GITHUB_WORKSPACE}/buildroot-external/meta | grep VERSION_BUILD | cut -d'=' -f2)
          echo "::set-output name=version_main::${major}.${build}"

  build:
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'run-dev-build') }}
    name: Release build for ${{ matrix.board.name }}
    needs: version
    strategy:
      fail-fast: false
      matrix:
        board:
          - {"name": "ova", "output": "ova", "runner": "x86-64-runner"}
          - {"name": "generic_x86_64", "output": "generic-x86-64", "runner": "x86-64-runner"}
          - {"name": "odroid_c2", "output": "odroid-c2", "runner": "aarch64-runner"}
          - {"name": "odroid_c4", "output": "odroid-c4", "runner": "aarch64-runner"}
          - {"name": "odroid_n2", "output": "odroid-n2", "runner": "aarch64-runner"}
          - {"name": "odroid_xu4", "output": "odroid-xu4" , "runner": "aarch64-runner"}
          - {"name": "rpi", "output": "rpi", "runner": "arm-runner"}
          - {"name": "rpi0_w", "output": "rpi0-w", "runner": "arm-runner"}
          - {"name": "rpi2", "output": "rpi2", "runner": "arm-runner"}
          - {"name": "rpi3", "output": "rpi3", "runner": "arm-runner"}
          - {"name": "rpi3_64", "output": "rpi3-64", "runner": "aarch64-runner"}
          - {"name": "rpi4", "output": "rpi4", "runner": "arm-runner"}
          - {"name": "rpi4_64", "output": "rpi4-64", "runner": "aarch64-runner"}
          - {"name": "tinker", "output": "tinker", "runner": "arm-runner"}
    runs-on: ${{ matrix.board.runner }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout source
        uses: actions/checkout@v2
        if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, matrix.board.name) }}
        with:
          submodules: true

      - name: Build container
        if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, matrix.board.name) }}
        run: docker build -t haos-builder .

      - name: 'Add release PKI certs'
        if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, matrix.board.name) }}
        env:
          RAUC_CERTIFICATE: ${{ secrets.RAUC_CERTIFICATE }}
          RAUC_PRIVATE_KEY: ${{ secrets.RAUC_PRIVATE_KEY }}
        run: |
          echo -e "-----BEGIN CERTIFICATE-----\n${RAUC_CERTIFICATE}\n-----END CERTIFICATE-----" > cert.pem
          echo -e "-----BEGIN PRIVATE KEY-----\n${RAUC_PRIVATE_KEY}\n-----END PRIVATE KEY-----" > key.pem

      - name: Build
        if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, matrix.board.name) }}
        run: |
          BUILDER_UID="$(id -u)"
          BUILDER_GID="$(id -g)"
          docker run --rm --privileged -v "${GITHUB_WORKSPACE}:/build" \
            -e BUILDER_UID="${BUILDER_UID}" -e BUILDER_GID="${BUILDER_GID}" \
            -v "${{ matrix.board.runner }}-build-cache:/cache" \
            haos-builder make BUILDDIR=/build VERSION_DEV=${{ needs.version.outputs.version_dev }} ${{ matrix.board.name }}

      - name: Upload images
        if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, matrix.board.name) }}
        uses: burnett01/rsync-deployments@4.1
        with:
          rsh: -q
          switches: -aW --ignore-existing
          path: release/
          remote_path: ${{ secrets.DEV_TARGET_PATH }}/${{ needs.version.outputs.version_main }}.${{ needs.version.outputs.version_dev }}/
          remote_host: ${{ secrets.DEV_HOST }}
          remote_port: ${{ secrets.DEV_PORT }}
          remote_user: ${{ secrets.DEV_USERNAME }}
          remote_key: ${{ secrets.DEV_SSH_KEY }}

  bump_version:
    name: Bump dev channel version
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [ build, version ]
    runs-on: [ "ubuntu-20.04" ]

    steps:
    - name: Initialize git
      uses: home-assistant/actions/helpers/git-init@master
      with:
        name: ${{ secrets.GIT_NAME }}
        email: ${{ secrets.GIT_EMAIL }}
        token: ${{ secrets.GIT_TOKEN }}

    - name: Bump Home Assistant OS dev channel version to ${{ needs.version.outputs.version_main }}.${{ needs.version.outputs.version_dev }}
      uses: home-assistant/actions/helpers/version-push@master
      with:
        key: "hassos[]"
        key-description: "Home Assistant OS"
        version: ${{ needs.version.outputs.version_main }}.${{ needs.version.outputs.version_dev }}
        channel: "dev"
